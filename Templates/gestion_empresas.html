{% extends "base.html" %}

{% block title %}Gestión de Multi-Empresa{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4 text-center text-danger">
        <i class="fas fa-sitemap me-2"></i> Gestión de Multi-Empresa
    </h1>
    <p class="text-center text-muted mb-5">
        Panel de control para Superadministradores: gestión completa de todas las empresas del sistema.
    </p>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-lg rounded-3">
                <div class="card-header bg-danger text-white rounded-top-3">
                    <h5 class="mb-0" id="empresa-form-title">Alta de Nueva Empresa</h5>
                </div>
                <div class="card-body">
                    <form id="formEmpresa" method="POST" action="{{ url_for('main.empresa_nuevo') }}">
                        <input type="hidden" name="empresa_id" id="empresa_id" value="">
                        
                        <div class="mb-3">
                            <label for="nombre_comercial" class="form-label">Nombre Comercial (*)</label>
                            <input type="text" class="form-control" id="nombre_comercial" name="nombre_comercial" required>
                        </div>
                        <div class="mb-3">
                            <label for="cif" class="form-label">CIF (*)</label>
                            <input type="text" class="form-control" id="cif" name="cif" required>
                        </div>
                        
                        <h6 class="mt-4 mb-3 text-secondary">Información de Contacto</h6>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefono" name="telefono">
                        </div>

                        <h6 class="mt-4 mb-3 text-secondary">Información de Domicilio</h6>
                        
                        <div class="mb-3">
                            <label for="domicilio" class="form-label">Domicilio (Calle, Número)</label>
                            <input type="text" class="form-control" id="domicilio" name="domicilio">
                        </div>
                        <div class="mb-3">
                            <label for="localidad" class="form-label">Localidad</label>
                            <input type="text" class="form-control" id="localidad" name="localidad">
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="codigo_postal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal">
                            </div>
                            <div class="col-md-6">
                                <label for="provincia" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="provincia" name="provincia">
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-plus me-2"></i> Crear Empresa
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetEmpresaForm()">
                                <i class="fas fa-undo me-1"></i> Limpiar Formulario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-lg rounded-3">
                <div class="card-header bg-dark text-white rounded-top-3">
                    <h5 class="mb-0">Listado de Empresas ({{ empresas | length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% if empresas %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Nombre Comercial</th>
                                    <th scope="col">CIF</th>
                                    <th scope="col">Empleados</th>
                                    <th scope="col" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for empresa in empresas %}
                                <tr>
                                    <td>{{ empresa.id }}</td>
                                    <td>{{ empresa.nombre_comercial }}</td>
                                    <td>{{ empresa.cif }}</td>
                                    <td>
                                        <span class="badge bg-info text-dark">{{ empresa.empleados | length }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% set empresa_data = {
                                            'id': empresa.id,
                                            'nombre_comercial': empresa.nombre_comercial,
                                            'cif': empresa.cif,
                                            'domicilio': empresa.domicilio or '',
                                            'localidad': empresa.localidad or '',
                                            'codigo_postal': empresa.codigo_postal or '',
                                            'provincia': empresa.provincia or '',
                                            'email': empresa.email or '',
                                            'telefono': empresa.telefono or ''
                                        } %}

                                        <button type="button" 
                                                class="btn btn-sm btn-info rounded-circle me-2" 
                                                title="Modificar Empresa"
                                                onclick='editarEmpresa({{ empresa_data | tojson }})'>
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <form method="POST" action="{{ url_for('main.empresa_eliminar', empresa_id=empresa.id) }}" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a {{ empresa.nombre_comercial }}?');">
                                            <button type="submit" 
                                                    class="btn btn-sm btn-danger rounded-circle" 
                                                    title="Eliminar Empresa"
                                                    {% if empresa.empleados | length > 0 %} disabled {% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="p-4 text-center text-info">No hay empresas registradas en el sistema.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function editarEmpresa(empresa) {
        document.getElementById('formEmpresa').action = '{{ url_for('main.empresa_modificar', empresa_id=1) }}'.replace('1', empresa.id);
        
        // 2. Asignar valores a los campos
        document.getElementById('empresa_id').value = empresa.id;
        document.getElementById('nombre_comercial').value = empresa.nombre_comercial;
        document.getElementById('cif').value = empresa.cif;
        document.getElementById('email').value = empresa.email;
        document.getElementById('telefono').value = empresa.telefono;

        document.getElementById('domicilio').value = empresa.domicilio; 
        document.getElementById('localidad').value = empresa.localidad; 
        document.getElementById('codigo_postal').value = empresa.codigo_postal; 
        document.getElementById('provincia').value = empresa.provincia; 
        
        document.getElementById('empresa-form-title').textContent = 'Modificación de Empresa (ID: ' + empresa.id + ')';
        document.querySelector('#formEmpresa button[type="submit"]').textContent = 'Guardar Cambios';
        document.querySelector('#formEmpresa button[type="submit"]').classList.remove('btn-danger');
        document.querySelector('#formEmpresa button[type="submit"]').classList.add('btn-success');
    }
    
    function resetEmpresaForm() {
        document.getElementById('formEmpresa').action = '{{ url_for('main.empresa_nuevo') }}';
        
        document.getElementById('empresa_id').value = '';
        document.getElementById('nombre_comercial').value = '';
        document.getElementById('cif').value = '';
        document.getElementById('email').value = '';
        document.getElementById('telefono').value = '';
        document.getElementById('domicilio').value = '';
        document.getElementById('localidad').value = '';
        document.getElementById('codigo_postal').value = '';
        document.getElementById('provincia').value = '';

        document.getElementById('empresa-form-title').textContent = 'Alta de Nueva Empresa';
        document.querySelector('#formEmpresa button[type="submit"]').textContent = 'Crear Empresa';
        document.querySelector('#formEmpresa button[type="submit"]').classList.remove('btn-success');
        document.querySelector('#formEmpresa button[type="submit"]').classList.add('btn-danger');
    }
</script>
{% endblock %}