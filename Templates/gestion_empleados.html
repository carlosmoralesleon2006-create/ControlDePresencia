{% extends "base.html" %}

{% block title %}Gestión de Empleados{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-5 text-center text-secondary">
        <i class="fas fa-users-cog me-2"></i> Gestión de Empleados
    </h1>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0" id="empleado-form-title">
                        {% if empleado_editar %}Modificar Empleado ({{ empleado_editar.nif }}){% else %}Alta de Nuevo Empleado{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form id="formEmpleado"
                          method="POST"
                          action="{{ url_for('main.empleado_nuevo') if not empleado_editar else url_for('main.empleado_modificar', nif_original=empleado_editar.nif) }}"
                          autocomplete="off">

                        {% if empleado_editar %}
                            <input type="hidden" name="nif_original" value="{{ empleado_editar.nif }}">
                        {% endif %}

                        <div class="mb-3">
                            <label for="nif" class="form-label">NIF (*)</label>
                            <input type="text" class="form-control rounded-pill" id="nif" name="nif" required
                                value="{% if empleado_editar %}{{ empleado_editar.nif }}{% endif %}">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nombre" class="form-label">Nombre (*)</label>
                                <input type="text" class="form-control rounded-pill" id="nombre" name="nombre" required
                                    value="{% if empleado_editar %}{{ empleado_editar.nombre }}{% endif %}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="apellidos" class="form-label">Apellidos (*)</label>
                                <input type="text" class="form-control rounded-pill" id="apellidos" name="apellidos" required
                                    value="{% if empleado_editar %}{{ empleado_editar.apellidos }}{% endif %}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_rol" class="form-label">Rol (*)</label>
                            <select class="form-select rounded-pill" id="id_rol" name="id_rol" required>
                                <option value="" disabled {% if not empleado_editar %}selected{% endif %}>Selecciona un rol</option>
                                {% for rol in roles %}
                                    {% if es_superadmin or rol.nombre == 'Empleado' %}
                                        <option value="{{ rol.id }}"
                                            {% if empleado_editar and empleado_editar.id_rol == rol.id %}selected{% endif %}>
                                            {{ rol.nombre }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        {% if es_superadmin %}
                            <div class="mb-3">
                                <label for="id_empresa" class="form-label">Asignar a Empresa (*)</label>
                                <select class="form-select rounded-pill" id="id_empresa" name="id_empresa" required>
                                    <option value="" disabled selected>Selecciona una empresa</option>
                                    {% for empresa in empresas_disponibles %}
                                        <option value="{{ empresa.id }}"
                                            {% if empleado_editar and empleado_editar.id_empresa == empresa.id %}selected{% endif %}
                                            {% if not empleado_editar and empresa.nombre_comercial == 'GLOBAL' and not empleado_editar %}selected{% endif %}>
                                            {{ empresa.nombre_comercial }} (CIF: {{ empresa.cif }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% else %}
                            <input type="hidden" name="id_empresa" value="{{ current_user.id_empresa }}">
                        {% endif %}

                        <div class="mb-3">
                            <label for="id_horario" class="form-label">Horario Asignado (*)</label>
                            <select class="form-select rounded-pill" id="id_horario" name="id_horario" required>
                                <option value="" disabled {% if not empleado_editar %}selected{% endif %}>Selecciona un horario</option>
                                {% for horario in horarios_disponibles %}
                                    <option value="{{ horario.id }}"
                                        {% if empleado_editar and empleado_editar.id_horario == horario.id %}selected{% endif %}
                                        {% if not empleado_editar and horario.id == 1 %}selected{% endif %}>
                                        
                                        {{ horario.nombre }}
                                        {% if horario.franjas %}
                                            [
                                            {% for franja in horario.franjas | sort(attribute='dia_semana') %}
                                                {{ {1:'L', 2:'M', 3:'X', 4:'J', 5:'V', 6:'S', 7:'D'}[franja.dia_semana] }}: 
                                                {{ franja.hora_inicio.strftime('%H:%M') }}-{{ franja.hora_fin.strftime('%H:%M') }}
                                                {% if not loop.last %}; {% endif %}
                                            {% endfor %}
                                            ]
                                        {% else %}
                                            (Sin franjas)
                                        {% endif %}
                                        
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email (*)</label>
                            <input type="email" class="form-control rounded-pill" id="email" name="email" required
                                value="{% if empleado_editar %}{{ empleado_editar.email }}{% endif %}">
                        </div>
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control rounded-pill" id="telefono" name="telefono"
                                value="{% if empleado_editar %}{{ empleado_editar.telefono or '' }}{% endif %}">
                        </div>
                        <div class="mb-4">
                            <label for="password" class="form-label">Contraseña {% if not empleado_editar %} (*){% else %} (Dejar vacío para no cambiar){% endif %}</label>
                            <input type="password" class="form-control rounded-pill" id="password" name="password"
                                {% if not empleado_editar %} required {% endif %}>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-save me-2"></i> {% if empleado_editar %} Guardar Cambios {% else %} Crear Empleado {% endif %}
                            </button>
                            <a href="{{ url_for('main.gestion_empleados') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i> {% if empleado_editar %} Cancelar Edición {% else %} Limpiar Formulario {% endif %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Listado de Empleados ({{ empleados | length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th scope="col">NIF</th>
                                    <th scope="col">Nombre Completo</th>
                                    <th scope="col">Rol</th>
                                    <th scope="col">Horario</th> {% if es_superadmin %}<th scope="col">Empresa</th>{% endif %}
                                    <th scope="col" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for empleado in empleados %}
                                <tr>
                                    <td>{{ empleado.nif }}</td>
                                    <td>{{ empleado.nombre }} {{ empleado.apellidos }}</td>
                                    <td>
                                        <span class="badge
                                            {% if empleado.rol_obj.nombre == 'Superadministrador' %}bg-danger
                                            {% elif empleado.rol_obj.nombre == 'Administrador' %}bg-warning text-dark
                                            {% else %}bg-primary{% endif %}">
                                            {{ empleado.rol_obj.nombre }}
                                        </span>
                                    </td>
                                    
                                    <td>
                                        {% if empleado.horario_obj %}
                                            <span class="fw-bold">{{ empleado.horario_obj.nombre }}</span>
                                            {% if empleado.horario_obj.franjas %}
                                                <div class="small mt-1 text-muted">
                                                {% for franja in empleado.horario_obj.franjas | sort(attribute='dia_semana') %}
                                                    <span class="badge bg-light text-dark border me-1">
                                                        {{ {1:'L', 2:'M', 3:'X', 4:'J', 5:'V', 6:'S', 7:'D'}[franja.dia_semana] }}: 
                                                        {{ franja.hora_inicio.strftime('%H:%M') }}-{{ franja.hora_fin.strftime('%H:%M') }}
                                                    </span>
                                                {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    {% if es_superadmin %}
                                    <td>{{ empleado.empresa_obj.nombre_comercial if empleado.empresa_obj else 'N/A' }}</td>
                                    {% endif %}
                                    <td class="text-center">
                                        <a href="{{ url_for('main.gestion_empleados', nif_editar=empleado.nif) }}"
                                            class="btn btn-sm btn-info rounded-circle me-2"
                                            title="Modificar Datos">
                                            <i class="fas fa-edit"></i>
                                        </a>

                                        <form method="POST" action="{{ url_for('main.empleado_eliminar', nif=empleado.nif) }}" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a {{ empleado.nombre }}?');">
                                            <button type="submit"
                                                    class="btn btn-sm btn-danger rounded-circle"
                                                    title="Eliminar Empleado"
                                                    {% if empleado.id == current_user.id %} disabled {% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}